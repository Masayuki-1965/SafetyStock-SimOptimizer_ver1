# 安全在庫最適化シミュレーションツール 要件定義書

## バージョン情報
- **プロジェクト名**: SafetyStock-SimOptimizer
- **バージョン**: ver1.0.0
- **最終更新日**: 2024-10-21

---

## 1. 開発目的

### 1.1 背景
安全在庫は一般的に「安全係数 × 受注数の標準偏差 × √（リードタイム + 間隔）」で算出されるが、この理論式で求めた値がそのまま"正解"とは限らない。

### 1.2 コンセプト
当社では、理論を尊重しつつも、実データに基づくデータドリブンなアプローチを重視する。リードタイム期間中の日々の受注実績の変動や、予測値と実績値の乖離を詳細に分析・シミュレーションすることで、「なぜその安全在庫量が必要なのか」を誰もが理解できる状態を目指す。

### 1.3 目的
以下の2種類のアプローチで安全在庫を算出し、視覚的に比較・検証できるツールを開発する：
- **安全在庫①（理論値）**: リードタイム期間中の日々の受注実績の変動をもとに、一般的な理論式で算出
- **安全在庫②（実測値）**: リードタイム期間中の日々の計画値−実績値の差分分布から、欠品許容率を加味して算出

---

## 2. 開発スタックと配布形式（必須要件）

### 2.1 技術スタック
| 項目 | 技術 |
|------|------|
| フレームワーク | Streamlit（ローカル実行想定） |
| 配布形態 | EXE配布（PyInstaller / onefolder） |
| エントリポイント | `run_app.py`（Streamlitをライブラリ起動） |
| グラフライブラリ | Plotly |
| データ処理 | Pandas, NumPy |

### 2.2 ディレクトリ構造
```
SafetyStock-SimOptimizer_ver1/
├── run_app.py               # EXE起動用エントリポイント
├── app.py                   # Streamlitメインアプリ
├── requirements.txt         # 依存パッケージ（厳格ピン留め）
├── README.md                # ビルド・実行手順
├── VERSION.txt              # バージョン情報
├── config/                  # 設定ファイル
│   └── settings.json
├── assets/                  # 静的リソース（ロゴ、スタイルシート等）
├── data/                    # サンプルデータ
│   ├── 日次計画.csv
│   └── 日次実績.csv
├── logs/                    # ログファイル出力先
├── tmp/                     # 一時ファイル出力先
├── modules/                 # ロジックモジュール
│   ├── __init__.py
│   ├── data_loader.py       # データ読み込み・統合
│   ├── safety_stock_theoretical.py  # 安全在庫①計算
│   ├── safety_stock_empirical.py    # 安全在庫②計算
│   └── utils.py             # ユーティリティ関数
└── SafetyStock-SimOptimizer_ver1.spec  # PyInstaller設定
```

### 2.3 配布要件
- **相対パス前提**: `./config`, `./assets`, `./data`, `./logs`, `./tmp` をアプリ配下で参照
- **依存固定**: `requirements.txt` を厳格ピン留め、開発・ビルドは同一Pythonマイナーバージョン
- **外部通信**: 原則なし（ローカル完結）
- **バージョン表示**: アプリUIに `VERSION.txt` を表示

### 2.4 納品物
1. ソース一式（Streamlit）
2. PyInstallerコマンド or `.spec`
3. ビルド手順（README）
4. `dist/SafetyStock-SimOptimizer_ver1/` を配布想定にできる構成

---

## 3. 機能要件

### 3.1 データ要件

#### 3.1.1 入力データ
| ファイル名 | 内容 | 形式 |
|-----------|------|------|
| `日次計画.csv` | 日次受注計画データ | 縦軸=商品コード、横軸=日付（YYYYMMDD・8桁）、セル=数量 |
| `日次実績.csv` | 日次受注実績データ | 縦軸=商品コード、横軸=日付（YYYYMMDD・8桁）、セル=数量 |

#### 3.1.2 データ期間
- **期間**: 2024/06/03〜2025/05/30
- **営業日**: 国内営業日のみ（土日祝は原則無し、土曜のみ発生する場合あり）

#### 3.1.3 対象機種（初期実装）
- `TT-157092-AWAA`
- `TT-157132-AWAA`
- `KK-C14682-AWAA`

### 3.2 計算ロジック

#### 3.2.1 共通設定

##### リードタイム指定
以下のいずれかを選択：
1. **カレンダー期間**（土日祝含む）
2. **稼働日期間**（土日祝除く）

**例**:
- 稼働日7日指定 → 稼働日で7日
- カレンダー7日指定 → 稼働日換算で約4〜5日

##### 欠品許容率
- ユーザーが任意に指定（例: 10%）
- 正規分布の片側確率として安全係数に変換

#### 3.2.2 安全在庫①（理論値）

##### 計算式
```
安全在庫① = 安全係数 × 受注数の標準偏差 × √（リードタイム + 間隔）
```

##### パラメータ
| パラメータ | 説明 |
|-----------|------|
| 間隔 | 0（都度生産） |
| リードタイム | 稼働日期間 or カレンダー期間に対応する平均稼働日数 |
| 標準偏差 | 推奨: 各リードタイム区間ごとに標準偏差を算出し、その平均を採用 |
| 安全係数 | 欠品許容率から逆算（正規分布の片側確率） |

##### 平均稼働日の算出（カレンダー期間指定時）
- カレンダー期間を1日ずつスライドして稼働日をカウント
- 件数 = データ期間 − カレンダー期間 + 1
- 平均値を算出

##### 可視化要件
1. 平均値・標準偏差・安全係数から理論的な正規分布を生成
2. ヒストグラム/密度を描画
3. 理論安全在庫値を縦線として重ねて表示
4. 図表のPNG保存、基データのCSV出力

#### 3.2.3 安全在庫②（実測値）

##### 計算ロジック
1. リードタイム期間の計画値合計と実績値合計を算出
2. 差分を計算: `差分 = 計画値計 − 実績値計`
3. 期間全体を1日ずつスライドして差分を算出
   - 件数 = データ期間 − リードタイム期間 + 1
4. 差分分布を作成

##### 安全在庫設定
- 欠品許容率（例: 10%）→ 差分分布の上位（プラス側）10%の閾値を安全在庫とする
- ヒストグラム左側90%（1 − 欠品許容率）をカバーする位置

##### 可視化要件
1. 差分分布のヒストグラム
   - 横軸 = 差分
   - 縦軸 = 頻度
   - 中央線 = 差分0
2. 設定した安全在庫を縦線で重ね表示
3. 図表PNG保存、分布CSV出力

### 3.3 UI/UX要件

#### 3.3.1 ページ構成

##### 左サイドバー
- 機種選択（複数選択可）
- リードタイム設定
  - タイプ選択: カレンダー期間 / 稼働日期間
  - 日数入力
- 欠品許容率入力（%）
- 標準偏差計算方法選択（理論値用）
  - 全期間標準偏差
  - 区間標準偏差の平均（推奨）
- 出力保存設定

##### メイン画面
機種ごとに以下を表示：

1. **安全在庫①（理論値）セクション**
   - 計算パラメータ表示
   - 正規分布ヒストグラム + 安全在庫ライン
   - 要約統計量テーブル
   - PNG/CSVエクスポートボタン

2. **安全在庫②（実測値）セクション**
   - 計算パラメータ表示
   - 差分分布ヒストグラム + 安全在庫ライン
   - 要約統計量テーブル
   - PNG/CSVエクスポートボタン

3. **比較テーブル**
   - 安全在庫①と②の比較
   - 差分・差分率を表示

#### 3.3.2 グラフ要件
- **ライブラリ**: Plotly
- **インタラクティブ性**: ズーム、パン、ホバー情報表示
- **縦線表示**: `add_vline` で安全在庫ラインを表示
- **色分け**: 安全在庫①と②で異なる色を使用

#### 3.3.3 エクスポート機能
- **PNG保存**: `st.download_button` で実装
- **CSV保存**: 分布データをCSV形式で出力
- **ファイル名規則**: `{機種}_{安全在庫種別}_{日時}.{拡張子}`

#### 3.3.4 フッター
- バージョン表示: `SafetyStock-SimOptimizer ver1.0.0`

### 3.4 パフォーマンス要件
- **キャッシュ**: `@st.cache_data` / `@st.cache_resource` を適用
  - データ読み込み
  - 集計処理
  - 分布作成
- **レスポンス**: パラメータ変更時の再計算は3秒以内

---

## 4. EXEビルド要件

### 4.1 PyInstaller設定
- **ビルドタイプ**: onefolder
- **エントリポイント**: `run_app.py`
- **オプション**: `--noconsole`, `--clean`

### 4.2 ビルドコマンド例（Windows）
```powershell
pyinstaller run_app.py ^
  --name SafetyStock-SimOptimizer_ver1 ^
  --noconsole ^
  --clean ^
  --add-data "config;config" ^
  --add-data "assets;assets" ^
  --add-data "data;data" ^
  --add-data "VERSION.txt;."
```

### 4.3 依存管理
- `requirements.txt` は厳格ピン留め（バージョン固定）
- Pythonバージョンも固定（例: Python 3.10.x）

### 4.4 ビルド手順
READMEに以下を記載：
1. 環境構築手順
2. 依存インストール手順
3. ビルドコマンド実行
4. 配布物の確認方法
5. 実行方法

---

## 5. 非機能要件

### 5.1 可用性
- オフライン環境で動作（外部通信なし）
- エラー時の適切なメッセージ表示

### 5.2 保守性
- モジュール分割による保守性向上
- 関数・クラスへの適切なドキュメント文字列
- 設定ファイルによる柔軟な設定変更

### 5.3 セキュリティ
- ローカルファイルのみアクセス
- 外部APIへの通信なし

### 5.4 ユーザビリティ
- 直感的なUI
- 適切なツールチップ・ヘルプ表示
- エラー時の分かりやすいメッセージ

---

## 6. 制約事項

### 6.1 技術的制約
- Windows環境でのビルド・実行を想定
- Python 3.9以上を推奨
- メモリ使用量: 最大2GB程度

### 6.2 データ制約
- CSV形式のみ対応
- 日付形式: YYYYMMDD（8桁）
- 文字コード: UTF-8（BOM付き推奨）

---

## 7. 今後の拡張性

### 7.1 機能拡張案
- 機種の動的追加・削除
- 複数シナリオの同時比較
- レポート自動生成（PDF）
- 履歴管理機能
- 推奨安全在庫の自動提案

### 7.2 技術的拡張案
- データベース連携
- Web版の展開
- リアルタイムデータ連携

---

## 8. 用語集

| 用語 | 説明 |
|------|------|
| 安全在庫 | 需要の変動やリードタイムのばらつきに対応するための在庫 |
| リードタイム | 発注から納品までの期間 |
| 欠品許容率 | 欠品を許容する確率（例: 10% = 90%のサービスレベル） |
| 安全係数 | 正規分布における標準偏差の倍率（欠品許容率から逆算） |
| 稼働日 | 営業日（土日祝を除く） |
| カレンダー日 | 土日祝を含むすべての日 |
| PSI | Production, Sales, Inventory（生産・販売・在庫計画） |

---

## 9. 参考資料

### 9.1 理論的背景
- 安全在庫の計算式: `SS = Z × σ × √(LT + I)`
  - SS: Safety Stock（安全在庫）
  - Z: Safety Factor（安全係数）
  - σ: Standard Deviation（標準偏差）
  - LT: Lead Time（リードタイム）
  - I: Interval（間隔）

### 9.2 統計的手法
- 正規分布の片側確率と安全係数の関係
- 分位点（パーセンタイル）の計算

---

## 10. 承認

| 役割 | 氏名 | 日付 | 署名 |
|------|------|------|------|
| 作成者 | AI Assistant | 2024-10-21 | - |
| 承認者 | - | - | - |

---

**ドキュメント管理**
- 文書番号: REQ-SS-001
- リビジョン: 1.0
- 次回レビュー日: 開発完了後


