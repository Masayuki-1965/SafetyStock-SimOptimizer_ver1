# 安全在庫最適化シミュレーションツール 要件定義書

## 1. プロジェクト概要

### 1.1 開発目的
本アプリケーションの目的は、PSI（計画・販売・在庫）運用の実態に即した安全在庫を算出・可視化し、計画精度と在庫量の連動管理を実現することである。一般的な理論式（教科書的手法）を出発点としつつ、実績および計画誤差の分布を分析することで、「どの程度の誤差を吸収できる安全在庫が必要か」すなわち、「なぜその安全在庫量が必要なのか」を定量的に説明できる状態を目指す。

### 1.2 背景
当社ではAIによる需要予測を導入しており、予測精度の向上＝安全在庫の縮小＝在庫効率の改善という構造を、定量的に評価・可視化できるように設計する。

### 1.3 主推奨モデル
安全在庫③：実測値（実績−計画）を主推奨モデルとして採用し、PSI運用実装モデルとして位置づける。

## 2. 開発環境・配布形式

### 2.1 技術仕様
- **フレームワーク**: Streamlit（ローカル実行）
- **配布形態**: PyInstaller / onefolder（EXE配布）
- **エントリポイント**: run_app.py（Streamlitライブラリを呼び出し起動）
- **相対パス構成**: ./config, ./assets, ./data, ./logs, ./tmp をアプリ配下で参照
- **依存固定**: requirements.txt 厳格ピン留め（開発・ビルド同一Pythonマイナーバージョン）
- **外部通信**: なし（ローカル完結）

### 2.2 UI要件
- フッターに SafetyStock-SimOptimizer_ver1 表示
- 出力要件：図表PNG/SVG保存、表CSVエクスポート、画面キャプチャボタン搭載

### 2.3 納品物
1. Streamlitソース一式
2. PyInstallerコマンドまたは .spec
3. ビルド手順（README）
4. dist/ToolName/ 構成一式

## 3. 対象データ

### 3.1 試算対象機種（トライアル）
- TT-157092-AWAA
- TT-157132-AWAA
- KK-C14682-AWAA

### 3.2 インプットデータ
- **入力CSV**:
  - 日次受注計画データ：@日次計画データ.csv
  - 日次受注実績データ：@日次実績データ.csv
- **形式**: 行＝商品コード、列＝日付（YYYYMMDD）、セル＝数量（数値）
- **期間**: 2024/06/03〜2025/05/30（国内営業日・土日祝は原則無し、一部土曜稼働あり）

### 3.3 分析用データセット
日付キーで計画と実績を統合して作成（安全在庫③算出用に必要）

## 4. リードタイム設定

### 4.1 種別選択
- 稼働日数（土日祝除く）
- カレンダー日数（土日祝含む）

### 4.2 例
- 稼働日7日指定→稼働日で7日
- カレンダー7日指定→稼働日換算で約4〜5日（稼働日カウント）

### 4.3 制限
- 上限：カレンダー最大60日（海外品対応）
- 稼働日カレンダー：内蔵（土日祝除外・一部土曜稼働考慮）

## 5. 3種類の安全在庫モデル

### 5.1 安全在庫① 理論値（教科書基準）
- **式**: 安全在庫① = Z × σ × √L
- **Z**: 欠品許容率pの片側Z値（デフォルトp=0.05 → P95 → Z=1.64485）
- **σ**: 日次実績の標準偏差
- **L**: 指定リードタイム（稼働日ベース）
- **可視化**: 安全在庫②のヒストグラム上に縦線（理論値）として重ね表示
- **位置づけ**: 比較基準／教科書的な安全在庫の原型

### 5.2 安全在庫② 実測値（実績−平均）
- **差分定義**: Δ2(t) = (リードタイム合計実績)−(リードタイム合計平均)
- **意味**: 右側（＋）＝平均を上回る実需＝欠品リスク側
- **安全在庫**: 安全在庫② = P95(Δ2)
- **可視化**: 横軸＝差分Δ2（act−ave）、縦軸＝件数、0線＝平均、縦線①＝理論値（Zσ√L）、縦線②＝実測P95

### 5.3 安全在庫③ 実測値（実績−計画）【推奨モデル】
- **差分定義（右側P95統一）**: Δ3(t) = (リードタイム合計実績)−(リードタイム合計計画)
- **意味**: 右側（＋）＝計画過小・欠品リスク、左側（−）＝計画過大・在庫超過
- **安全在庫**: 安全在庫③ = P95(Δ3)
- **可視化**: 横軸＝Δ3（act−plan）、縦軸＝件数、0線＝計画と実績一致点、縦線③＝P95
- **位置づけ**: PSI運用実装モデル（主推奨）

## 6. Streamlit UI構成

### 6.1 サイドバー
- 機種選択（複数選択可）
- リードタイム設定（カレンダー／稼働）
- 欠品許容率スライダー（1〜50%、デフォルト5% P95）
- 標準偏差の定義（母分散／不偏）
- 保存設定（PNG／CSV）

### 6.2 メイン画面
- 実測ヒストグラム（②）＋理論線（①）重ね表示
- 実績−計画ヒストグラム（③）
- 比較テーブル表示（安全在庫①②③と諸要素の比較）
- エクスポートボタン（PNG, CSV）

## 7. 計算ロジック（Python擬似コード）

```python
# 欠品許容率 p（ユーザー入力／デフォルト=0.05）
Z = norm.ppf(1 - p)

# ① 理論式
sigma_daily = actual.std(ddof=0)
SS_theory = Z * sigma_daily * np.sqrt(L)

# ② 実績−平均
SumAct = actual.rolling(L).sum().dropna()
Delta2 = SumAct - SumAct.mean()
SS_emp_act = np.quantile(Delta2, 1 - p)

# ③ 実績−計画（推奨）
SumPlan = plan.rolling(L).sum().dropna()
common_idx = SumAct.index.intersection(SumPlan.index)
Delta3 = SumAct.loc[common_idx] - SumPlan.loc[common_idx]
SS_emp_plan = np.quantile(Delta3, 1 - p)
```

## 8. EXEビルド仕様

### 8.1 PyInstallerコマンド
```bash
pyinstaller run_app.py --name SafetyStock-SimOptimizer_ver1 --noconsole --clean ^
  --add-data "config;config" --add-data "assets;assets" --add-data "data;data"
```

### 8.2 要件
- requirements.txt 厳格ピン留め
- Pythonバージョン固定
- READMEにビルド・実行手順を明記

## 9. 受入基準

### 9.1 機能要件
- 欠品許容率p（デフォルト5%）を動的変更可能
- 3機種で再現可能（実績−平均・実績−計画）
- PNG／CSV出力が正常動作
- 理論線＋実測ヒストグラムが整合

### 9.2 技術要件
- EXEビルドが成功し単体実行可能

## 10. 総括メッセージ

本ツールは、安全在庫を「理論」から「実運用」へと橋渡しする。PSIは計画値を基準に意思決定されるため、実績−計画ベースの③モデルを採用し、AI計画精度と安全在庫量を一体管理する。欠品許容率のデフォルトは5%（P95）とし、精度や業務特性に応じて可変化することで、計画精度の向上と在庫削減を同時に実現する。
